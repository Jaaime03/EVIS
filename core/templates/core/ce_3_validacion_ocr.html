{% extends 'core/base_ce.html' %}
{% load static %}

{% block title %}EVIS - Validación OCR{% endblock title %}

{% block extra_css %}
<style>
    /* --- ESTILOS ESPECÍFICOS PARA ce_3_validacion_ocr.html --- */
/* --- ESTILOS ESPECÍFICOS DE ce_2_carga.html --- */
    .exercise-info-bar { display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; background-color: var(--white); padding: 15px 20px; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); width: 100%; max-width: 1200px; margin-bottom: 30px; }
    .info-item { display: flex; flex-direction: column; align-items: center; padding: 5px 15px; text-align: center; min-width: 180px; }
    .info-item strong { font-size: 0.9em; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; }
    .info-item span { font-size: 1.1em; font-weight: 700; color: var(--text-primary); }
    
    .progress-section { width: 100%; max-width: 1200px; margin-bottom: 30px; padding: 25px; background-color: var(--white); border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .progress-section h2 { text-align: center; font-size: clamp(20px, 3vw, 26px); font-weight: 800; margin-bottom: 25px; color: var(--text-primary); }
    
    .progress-bar-container { position: relative; height: 6px; background-color: #e0e0e0; border-radius: 3px; margin: 45px 0; }
    .progress-bar-steps { display: flex; justify-content: space-between; position: absolute; width: 100%; top: 50%; transform: translateY(-50%); padding: 0 5px; }
    .progress-step { display: flex; flex-direction: column; align-items: center; text-align: center; position: relative; }
    .progress-step .circle { width: 40px; height: 40px; border-radius: 50%; background-color: var(--white); border: 3px solid #cccccc; display: flex; justify-content: center; align-items: center; font-weight: bold; color: var(--text-secondary); margin-bottom: 8px; z-index: 1; transition: background-color 0.3s, border-color 0.3s, color 0.3s; }
    .progress-step .label { font-size: 0.9em; color: var(--text-secondary); font-weight: 600; margin-top: 5px; width: 120px; }
    
    .progress-step.active .circle { border-color: var(--primary-blue); background-color: var(--primary-blue); color: var(--white); }
    .progress-step.completed .circle { border-color: var(--success-green); background-color: var(--success-green); color: var(--white); }
    .progress-step.active .label, .progress-step.completed .label { color: var(--text-primary); }
    .progress-line { position: absolute; height: 100%; background-color: var(--primary-blue); border-radius: 3px; left: 0; width: 0%; z-index: 0; transition: width 0.5s ease-out; }
    
    .validation-ocr-container {
        width: 100%;
        max-width: 1300px; /* Un poco más ancho para las 3 columnas */
        margin-bottom: 30px;
        position: relative;

    }

    .validation-ocr-header {
        text-align: center;
        margin-bottom: 30px;
    }
    .validation-ocr-header h2 {
        font-size: clamp(24px, 3.5vw, 30px);
        font-weight: 800;
        color: var(--text-primary);
    }

    .image-navigation {
        display: flex;
        justify-content: space-between; /* Para espaciar el contador y los botones */
        align-items: center;
        margin-bottom: 25px;
        padding: 10px;
        background-color: var(--white);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .image-navigation .validations-remaining {
        font-size: 1em;
        font-weight: 600;
        color: var(--text-secondary);
    }
    .image-navigation .nav-buttons button {
        background-color: var(--secondary-blue);
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.2em; /* Iconos más grandes */
        margin-left: 10px;
    }
    .image-navigation .nav-buttons button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }

    .ocr-validation-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 25px;
        align-items: stretch; /* Para que las columnas tengan la misma altura */
    }

    .ocr-column {
        background-color: var(--white);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        display: flex;
        flex-direction: column; /* Para alinear título y contenido */
    }
    .ocr-column h3 {
        font-size: 1.1em;
        font-weight: 700;
        margin-bottom: 15px;
        color: var(--text-primary);
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--input-border);
    }

    /* Columna Imagen Original */
    .original-image-area {
        flex-grow: 1; /* Para que ocupe el espacio disponible */
        background-color: var(--field-background); /* Un fondo ligeramente diferente */
        border: 1px dashed var(--input-border);
        border-radius: 8px;
        padding: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 300px; /* Altura mínima */
        position: relative; /* Para el botón de zoom */
        overflow: hidden; /* Para controlar el zoom */
    }
    .original-image-area img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        cursor: zoom-in;
        transition: transform 0.3s ease;
    }


.ocr-column .corrected-text-area-wrapper { /* Nuevo wrapper para aplicar estilos de fondo/borde */
    border-radius: 8px;
    padding: 2px; /* Pequeño padding para que el borde no pegue al textarea */
    background-color: var(--field-background); /* Fondo por defecto */
    border: 2px solid transparent; /* Borde transparente por defecto */
    transition: background-color 0.3s ease, border-color 0.3s ease;
    flex-grow: 1; /* Para que ocupe espacio */
    display: flex; /* Para que el textarea interior se expanda */
}

.ocr-column .corrected-text-area-wrapper.status-correct {
    background-color: #e6ffed; /* Fondo verde claro */
    border-color: var(--success-green); /* Borde verde */
}

.ocr-column .corrected-text-area-wrapper.status-corrected-saved {
    background-color: #e7f3ff; /* Fondo azul claro */
    border-color: var(--primary-blue); /* Borde azul */
}

.ocr-column .corrected-text-area-wrapper.status-editing {
    background-color: var(--white); /* Fondo blanco mientras se edita */
    border-color: var(--secondary-blue); /* Borde azul más brillante para indicar edición activa */
}

.ocr-column .corrected-text-area-wrapper textarea { /* Asegúrate que el textarea sea transparente */
    background-color: transparent !important; 
    height: 100%;
    width: 100%;
    border: none;
    resize: none;
    padding: 15px; /* Padding interno del textarea */
    font-family: 'Courier New', Courier, monospace;
    font-size: 0.95em;
    line-height: 1.6;
}
.ocr-column .corrected-text-area-wrapper.disabled textarea {
    color: var(--text-secondary);
    cursor: default; /* Cambiado de not-allowed a default */
}


/* Visibilidad de botones de acción si es necesario */
.validation-buttons .btn-confirm-correction,
.validation-buttons .btn-cancel-correction {
    display: none; /* Ocultos por defecto */
}

.validation-buttons.editing .btn-correct, /* Ocultar "BIEN TRANSCRITO" */
.validation-buttons.editing .btn-incorrect { /* Ocultar "MAL TRANSCRITO" */
    display: none;
}

.validation-buttons.editing .btn-confirm-correction, /* Mostrar "Guardar Corrección" */
.validation-buttons.editing .btn-cancel-correction { /* Mostrar "Cancelar" */
    display: block; /* O inline-block/flex según tu layout */
}
    /* Columna OCR Análisis y Texto Correcto */
    .ocr-text-area, .corrected-text-area {
        flex-grow: 1;
        font-family: 'Courier New', Courier, monospace; /* Fuente monoespaciada para código/texto */
        font-size: 0.95em;
        line-height: 1.6;
        padding: 15px;
        border-radius: 8px;
        background-color: var(--field-background);
        color: var(--text-primary);
        white-space: pre-wrap; /* Conserva espacios y saltos de línea */
        word-wrap: break-word;
        min-height: 300px; /* Altura mínima */
        overflow-y: auto; /* Scroll si el texto es muy largo */
    }
    .corrected-text-area textarea {
        width: 100%;
        height: 100%; /* Ocupa todo el espacio del div padre */
        min-height: 280px; /* Ajusta según necesidad */
        border: none;
        padding: 0;
        font-family: 'Courier New', Courier, monospace;
        font-size: 1em; /* Hereda o iguala el tamaño */
        line-height: 1.6;
        background-color: transparent; /* Fondo transparente para que tome el del div */
        resize: none; /* Evitar que el usuario redimensione */
    }
    .corrected-text-area textarea:focus {
        outline: none;
    }
    .corrected-text-area.disabled textarea { /* Para cuando está deshabilitada */
        background-color: #e9ecef; /* Un gris más claro */
        color: var(--text-secondary);
        cursor: not-allowed;
    }

    .validation-buttons {
        margin-top: 20px;
        display: flex;
        flex-direction: column; /* Para poner los botones uno encima del otro */
        gap: 10px;
    }
    .validation-buttons button {
        width: 100%;
        padding: 12px 15px;
        font-size: 1em;
        font-weight: 700;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: opacity 0.2s ease;
    }
    .validation-buttons button:hover {
        opacity: 0.85;
    }
    .btn-correct {
        background-color: var(--success-green);
        color: white;
    }
    .btn-incorrect {
        background-color: var(--danger-red);
        color: white;
    }
    .correction-note {
        font-size: 0.8em;
        color: var(--text-secondary);
        margin-top: 15px;
        line-height: 1.5;
        text-align: justify;
    }
    .correction-note strong { color: var(--primary-blue); }

    /* Botones de acción inferiores */
    .page-actions {
        width: 100%;
        max-width: 1300px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 40px;
        padding-top: 20px;
        border-top: 1px solid var(--input-border);
    }
    .page-actions .btn-page-action {
        padding: 12px 30px;
        font-size: 1.05em;
        font-weight: 700;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    .btn-page-action.prev {
        background-color: var(--light-gray);
        color: var(--text-primary);
    }
    .btn-page-action.prev:hover { background-color: #b0b0b0; }

    .btn-page-action.next {
        background-color: var(--primary-blue);
        color: white;
    }
    .btn-page-action.next:hover { background-color: #303dbb; }
    .btn-page-action.next:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    .validation-hint {
        text-align: center;
        font-size: 0.9em;
        color: var(--danger-red);
        margin-top: 15px;
        display: none; /* Oculto por defecto */
    }
    .validation-hint.visible { display: block; }
/* --- Estilos para la sección "Datos ejercicio" --- */
    .datos-ejercicio-container {
        background-color: var(--white);
        padding: 30px 40px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        width: 100%;
        max-width: 700px; /* O el ancho que desees */
        margin-bottom: 40px; /* Espacio antes de la barra de progreso */
    }
    .datos-ejercicio-container h2 {
        text-align: center;
        font-size: clamp(20px, 3vw, 24px);
        font-weight: 800;
        margin-bottom: 30px;
        color: var(--text-primary);
    }
    .dato-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 18px;
        padding-bottom: 18px;
        border-bottom: 1px solid var(--input-border);
    }
    .dato-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }
    .dato-item .label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 15px;
        margin-right: 20px;
        white-space: nowrap; /* Evita que el label se parta */
    }
    .dato-item .value {
        font-weight: 700;
        color: var(--text-primary);
        background-color: #F0F0F0; /* Fondo gris claro para el valor */
        padding: 10px 15px;
        border-radius: 8px;
        font-size: 16px;
        text-align: left; /* Cambiado de right a left para mejor lectura */
        flex-grow: 1; 
    }
    .enlarged-image-popup-area {
    /* position: absolute; QUITAMOS ESTO */
    /* top: 60px; QUITAMOS ESTO */
    /* left: 50%; QUITAMOS ESTO */
    /* transform: translateX(-50%); QUITAMOS ESTO */
    
    width: 90%; /* O el ancho que desees, se centrará si el padre es flex o con margin auto */
    max-width: 800px; 
    max-height: 70vh; 
    background-color: #ffffff;
    border: 1px solid #ccc;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    padding: 15px;
    /* z-index: 500; Ya no es tan crucial si está en el flujo, pero no hace daño */
    border-radius: 8px;
    /* display: none; Se maneja con JS, pero empezamos con él oculto */
    display: flex; /* Para centrar la imagen y el botón de cerrar si es necesario */
    flex-direction: column;
    align-items: center;
    margin: 20px auto; /* Margen superior e inferior, y auto para centrar horizontalmente si es un block-level element */
    position: relative; /* Para que el botón de cerrar se posicione relativo a este div */
}

.enlarged-image-popup-area img#enlarged-image-content {
    max-width: 100%;
    max-height: calc(70vh - 60px); /* Ajustar para dejar espacio al padding y botón de cerrar */
    object-fit: contain;
    margin-bottom: 10px; 
}

.enlarged-image-popup-area .close-enlarged-btn {
    position: absolute;
    top: 5px;  /* Ajusta la posición del botón de cerrar dentro del popup */
    right: 10px;
    background: rgba(0,0,0,0.3);
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    font-size: 20px;
    line-height: 30px;
    text-align: center;
    cursor: pointer;
    font-weight: bold;
    z-index: 10; /* Para estar sobre la imagen si se superponen */
}
.enlarged-image-popup-area .close-enlarged-btn:hover {
    background: rgba(0,0,0,0.6);
}




/* Modificación para el cursor de la imagen original */
.original-image-area img {
    cursor: pointer; /* O zoom-in si prefieres, para indicar que se puede ampliar */
    /* Quita la transición de transform si la tenías para el zoom anterior */
    transition: none; /* O elimina la línea de transition si estaba */
}
</style>
{% endblock extra_css %}

{% block content %}
    {# Barra de progreso (igual a ce_2_carga.html, asegúrate que el JS la actualice al paso 2) #}
     <section class="page-title-section" style="text-align: center; padding: 0 0 20px 0; width:100%; max-width:900px;">
        {# Este título es opcional si ya lo tienes en el bloque page_title de la base #}
        {# Si base_ce.html YA tiene un bloque para el título principal, este h1 podría no ser necesario aquí #}
        <h1 style="font-size: clamp(24px, 4vw, 30px); font-weight: 900; color: var(--text-primary);">
            Sistema de Reconocimiento y Validación Automática
        </h1>
    </section>

    <div class="datos-ejercicio-container">
        <h2>Datos ejercicio</h2>
        <div class="dato-item">
            <span class="label">Nombre Ejercicio</span>
            <span class="value">{{ ejercicio.nombre|default:"No proporcionado" }}</span>
        </div>
        <div class="dato-item">
            <span class="label">Asignatura</span>
            <span class="value">{{ ejercicio.asignatura|default:"No proporcionada" }}</span>
        </div>
        <div class="dato-item">
            <span class="label">Convocatoria</span>
            <span class="value">{{ ejercicio.convocatoria|default:"No proporcionada" }}</span>
        </div>
        <div class="dato-item">
            <span class="label">Fecha examen</span>
            <span class="value">{{ ejercicio.fecha_examen|date:"d/m/Y"|default:"No proporcionada" }}</span>
        </div>
    </div>

    <section class="progress-section">
        <h2>Corrección de Exámenes con IA</h2>
        <div class="progress-bar-container">
            <div class="progress-line" id="progress-line"></div> {# El JS debe ponerla al 50% para el paso 2 #}
            <div class="progress-bar-steps">
                <div class="progress-step completed" id="step-1"> {# Paso 1 completado #}
                    <div class="circle">1</div><div class="label">Penalización Errores</div>
                </div>
                <div class="progress-step active" id="step-2"> {# Paso 2 activo #}
                    <div class="circle">2</div><div class="label">Validación OCR</div>
                </div>
                <div class="progress-step" id="step-3">
                    <div class="circle">3</div><div class="label">Corrección de errores</div>
                </div>
            </div>
        </div>
    </section>

    <div class="validation-ocr-container" data-total="{{ ejercicios_list|length }}">
        <div class="validation-ocr-header">
            <h2>Validación OCR</h2>
        </div>

        <div class="image-navigation">
            <span class="validations-remaining" id="validations-remaining-text">VALIDACIONES RESTANTES: <span id="current-index">1</span>/{{ ejercicios_alumno|length }}</span>
            <div class="nav-buttons">
                <button id="prev-image-btn" title="Imagen Anterior"><i class="fas fa-arrow-left"></i></button>
                <button id="next-image-btn" title="Siguiente Imagen"><i class="fas fa-arrow-right"></i></button>
            </div>
        </div>

        <div id="enlarged-image-popup" class="enlarged-image-popup-area" style="display: none;">
            <img id="enlarged-image-content" src="#" alt="Imagen Original Ampliada">
            <button id="close-enlarged-image-btn" class="close-enlarged-btn">&times;</button>
        </div>

        <div class="ocr-validation-grid">
            <div class="ocr-column">
                <h3>Imagen Original</h3>
                <div class="original-image-area">
                    <img id="original-image-display" src="" alt="Imagen Original del Examen">
                </div>
            </div>

            <div class="ocr-column">
                <h3>OCR Análisis</h3>
                <div class="ocr-text-area" id="ocr-analysis-text"></div>
            </div>

            <div class="ocr-column">
                <h3>TEXTO CORRECTO</h3>
                <div class="corrected-text-area-wrapper" id="corrected-text-wrapper">
                    <textarea id="corrected-text-input" rows="10" disabled></textarea>
                </div>
                <div class="validation-buttons" id="validation-buttons-container">
                    <button class="btn-correct" id="btn-transcribed-correctly">BIEN TRANSCRITO</button>
                    <button class="btn-incorrect" id="btn-transcribed-incorrectly">MAL TRANSCRITO</button>

                    <button class="btn-correct btn-confirm-correction" id="btn-confirm-correction">Guardar Corrección</button>
                    <button class="btn-incorrect btn-cancel-correction" id="btn-cancel-correction">Cancelar</button>
                </div>
            </div>
        </div>

        <div class="page-actions">
            <button class="btn-page-action prev" id="btn-ocr-previous-page">
                <i class="fas fa-arrow-left"></i> Anterior
            </button>
            <button class="btn-page-action next" id="btn-ocr-next-page">
                Siguiente <i class="fas fa-arrow-right"></i>
            </button>
        </div>

        <p class="validation-hint" id="ocr-validation-hint">Debes validar todas las transcripciones antes de poder continuar.</p>
    </div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log("JS DEBUG: DOM cargado para ce_3_validacion_ocr.html.");

    // --- Selectores de Elementos (como los tenías, deberían estar bien) ---
    const progressLine = document.getElementById('progress-line');
    const validationsRemainingText = document.getElementById('validations-remaining-text');
    const prevImageBtn = document.getElementById('prev-image-btn'); // Navegación entre imágenes de alumnos
    const nextImageBtn = document.getElementById('next-image-btn'); // Navegación entre imágenes de alumnos
    const ocrAnalysisText = document.getElementById('ocr-analysis-text');
    const correctedTextWrapper = document.getElementById('corrected-text-wrapper');
    const correctedTextInput = document.getElementById('corrected-text-input');
    const validationButtonsContainer = document.getElementById('validation-buttons-container');
    const btnTranscribedCorrectly = document.getElementById('btn-transcribed-correctly');
    const btnTranscribedIncorrectly = document.getElementById('btn-transcribed-incorrectly');
    const btnConfirmCorrection = document.getElementById('btn-confirm-correction');
    const btnCancelCorrection = document.getElementById('btn-cancel-correction');
    const btnOcrPreviousPage = document.getElementById('btn-ocr-previous-page'); // Botón grande "Anterior" (al paso 2)
    const btnOcrNextPage = document.getElementById('btn-ocr-next-page');     // Botón grande "Siguiente" (al paso 4)
    const ocrValidationHint = document.getElementById('ocr-validation-hint');
    const originalImageDisplay = document.getElementById('original-image-display');
    const enlargedImagePopup = document.getElementById('enlarged-image-popup');
    const enlargedImageContent = document.getElementById('enlarged-image-content');
    const closeEnlargedImageBtn = document.getElementById('close-enlarged-image-btn');

    // ID del enunciado actual, pasado desde el contexto de la vista Django
    const enunciadoId = "{{ ejercicio.id_enunciado_ejercicio|default_if_none:'' }}";
    // If the value is numeric, output as-is; if possibly null, output null (no quotes)
    // If you want to ensure it's always a number or null, use:
    // const enunciadoId = {{ ejercicio.id_enunciado_ejercicio|default:"null" }};
    // If you want to ensure it's a string or null, use:
    // const enunciadoId = "{{ ejercicio.id_enunciado_ejercicio|default_if_none:'' }}";
    console.log("JS DEBUG: Enunciado ID actual:", enunciadoId);

    // --- Carga y Preparación de Datos de Ejercicios de Alumnos ---
    const ejerciciosAlumnoJsonString = '{{ ejercicios_alumno_json|escapejs|default:"[]" }}';
    let ocrValidations = []; // Este será nuestro array de trabajo

    try {
        const rawOcrData = JSON.parse(ejerciciosAlumnoJsonString);
        console.log("JS DEBUG: Datos OCR crudos parseados desde Django:", rawOcrData);
        // Mapear y asegurar campos necesarios para la lógica JS existente
        ocrValidations = rawOcrData.map(item => ({
            id: item.id, // ID de EjercicioAlumno
            id_alumno_str: item.id_alumno_str, // ID del Alumno
            // El JS espera 'imageUrl' y 'ocrText' para las funciones loadValidationData/setValidationInterfaceState
            // La vista ahora envía 'imagen_url' y 'ocr_texto'. Hacemos el mapeo aquí:
            imageUrl: item.imagen_url, 
            ocrText: item.ocr_texto,   
            correctedText: item.correctedText === undefined ? (item.correccion_humana || null) : item.correctedText,
            status: item.status || 'pending' 
        }));
        console.log("JS DEBUG: Datos OCR procesados para el JS (ocrValidations):", ocrValidations);
    } catch (e) {
        console.error("JS ERROR: Al parsear ejercicios_alumno_json:", e, "\nString recibido:", ejerciciosAlumnoJsonString);
        alert("Error al cargar los datos de los ejercicios. Por favor, recarga la página o contacta a soporte.");
        // Deshabilitar controles si los datos no se cargan
        if(prevImageBtn) prevImageBtn.disabled = true;
        if(nextImageBtn) nextImageBtn.disabled = true;
        if(btnOcrNextPage) btnOcrNextPage.disabled = true;
    }

    let currentImageIndex = 0;
    const totalImages = ocrValidations.length;

    // --- Funciones (updateProgressBarOCR, setValidationInterfaceState, loadValidationData, etc.) ---
    // Estas funciones deberían estar bien como las tenías, siempre que usen
    // ocrValidations[currentImageIndex].imageUrl y ocrValidations[currentImageIndex].ocrText
    // y ocrValidations[currentImageIndex].correctedText

    function updateProgressBarOCR() {
        if (progressLine) progressLine.style.width = '50%'; // Paso 2 de 3 -> 50%
        document.getElementById('step-1')?.classList.add('completed');
        document.getElementById('step-1')?.classList.remove('active');
        document.getElementById('step-2')?.classList.add('active');
        document.getElementById('step-2')?.classList.remove('completed');
        document.getElementById('step-3')?.classList.remove('active', 'completed');
    }

    function setValidationInterfaceState(status) {
        if (!ocrValidations[currentImageIndex]) return; // Seguridad
        correctedTextWrapper.classList.remove('status-correct', 'status-corrected-saved', 'status-editing', 'disabled');
        validationButtonsContainer.classList.remove('editing');

        const currentOcrItem = ocrValidations[currentImageIndex];
        switch (status) {
            case 'pending':
                correctedTextInput.value = currentOcrItem.ocrText; // Usa ocrText
                correctedTextInput.disabled = true;
                correctedTextWrapper.classList.add('disabled');
                break;
            case 'correct':
                correctedTextInput.value = currentOcrItem.ocrText; // Usa ocrText
                correctedTextInput.disabled = true;
                correctedTextWrapper.classList.add('status-correct', 'disabled');
                break;
            case 'corrected_saved':
                correctedTextInput.value = currentOcrItem.correctedText || ''; // Usa correctedText
                correctedTextInput.disabled = true;
                correctedTextWrapper.classList.add('status-corrected-saved', 'disabled');
                break;
            case 'editing':
                correctedTextInput.value = currentOcrItem.correctedText || currentOcrItem.ocrText;
                correctedTextInput.disabled = false;
                correctedTextWrapper.classList.add('status-editing');
                validationButtonsContainer.classList.add('editing');
                correctedTextInput.focus();
                break;
        }
    }

    function loadValidationData(index) {
        if (index < 0 || index >= ocrValidations.length) {
            console.warn("JS WARN: Índice fuera de rango para loadValidationData:", index);
            return;
        }
        const data = ocrValidations[index];
        if (!data) {
            console.error("JS ERROR: No hay datos para el índice:", index, "en ocrValidations.");
            return;
        }

        originalImageDisplay.src = data.imageUrl || "{% static 'core/img/placeholder_ocr_image.png' %}"; // Usa imageUrl
        ocrAnalysisText.textContent = data.ocrText || "No disponible"; // Usa ocrText
        
        if (data.status === 'editing' && index !== currentImageIndex) {
             data.status = 'pending'; 
        }
        if (enlargedImagePopup && enlargedImagePopup.style.display === 'flex') {
            if (enlargedImageContent) {
                enlargedImageContent.src = data.imageUrl || "{% static 'core/img/placeholder_ocr_image.png' %}";
            }
        }
        currentImageIndex = index;
        setValidationInterfaceState(data.status);
        updateNavigation();
        checkAllValidated();
    }

    function updateNavigation() {
        if (!validationsRemainingText || !prevImageBtn || !nextImageBtn) return;
        const pendingCount = ocrValidations.filter(v => v.status === 'pending' || v.status === 'editing').length;
        // Actualizar el span anidado para el índice actual, y el texto general
        const currentIndexDisplay = document.getElementById('current-index'); 
        if (currentIndexDisplay) currentIndexDisplay.textContent = totalImages > 0 ? currentImageIndex + 1 : 0;
        
        const totalImagesDisplay = totalImages; // El total no cambia
        
        validationsRemainingText.innerHTML = `VALIDACIONES RESTANTES: ${pendingCount}/${totalImages} (Mostrando <span id="current-index">${totalImages > 0 ? currentImageIndex + 1 : 0}</span>/${totalImagesDisplay})`;

        prevImageBtn.disabled = currentImageIndex === 0;
        nextImageBtn.disabled = currentImageIndex === totalImages - 1;
    }

    function checkAllValidated() {
        if(!btnOcrNextPage || !ocrValidationHint) return;
        const allDone = ocrValidations.every(v => v.status === 'correct' || v.status === 'corrected_saved');
        btnOcrNextPage.disabled = !allDone;
        ocrValidationHint.classList.toggle('visible', !allDone);
    }

    function goToNextImageOrFinish() {
        // Aquí es donde llamarías al backend para guardar la validación actual
        // Por ahora, solo actualiza el estado en el array JS y navega
        const currentData = ocrValidations[currentImageIndex];
        console.log(`JS DEBUG: Guardando estado para imagen ${currentData.id}: ${currentData.status}, Texto: ${currentData.correctedText || currentData.ocrText}`);
        // TODO: Implementar llamada fetch para guardar 'currentData' en el backend.
        // URL podría ser algo como /ejercicio-alumno/${currentData.id}/correccion-ocr/
        // y el body contendría { correcto_ocr: (status === 'correct'), correccion_ocr_hum: (status === 'corrected_saved' ? correctedText : '') }

        if (currentImageIndex < totalImages - 1) {
            currentImageIndex++;
            loadValidationData(currentImageIndex);
        } else {
            loadValidationData(currentImageIndex); 
            alert("Todas las imágenes han sido procesadas para validación en esta página.");
        }
        checkAllValidated(); // Asegurarse que el botón "Siguiente" se actualice
    }

    // --- Event Listeners (Mayormente como los tenías) ---
    if (originalImageDisplay && enlargedImagePopup && enlargedImageContent && closeEnlargedImageBtn) {
        originalImageDisplay.addEventListener('click', function() {
            enlargedImageContent.src = this.src; 
            enlargedImagePopup.style.display = 'flex'; 
        });
        closeEnlargedImageBtn.addEventListener('click', function() {
            enlargedImagePopup.style.display = 'none'; 
        });
        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape" && enlargedImagePopup.style.display === 'flex') {
                enlargedImagePopup.style.display = 'none';
            }
        });
    }

    if (prevImageBtn) {
        prevImageBtn.addEventListener('click', () => { /* ... (lógica sin cambios, pero verifica que usa 'currentData.status') ... */
            const currentData = ocrValidations[currentImageIndex];
            if (currentData.status === 'editing') {
                alert("Por favor, guarda o cancela tu corrección actual antes de navegar."); return;
            }
            if (currentImageIndex > 0) { currentImageIndex--; loadValidationData(currentImageIndex); }
        });
    }

    if (nextImageBtn) {
        nextImageBtn.addEventListener('click', () => { /* ... (lógica sin cambios, pero verifica que usa 'currentData.status') ... */
            const currentData = ocrValidations[currentImageIndex];
            if (currentData.status === 'editing') {
                alert("Por favor, guarda o cancela tu corrección actual antes de navegar."); return;
            }
            if (currentImageIndex < totalImages - 1) { currentImageIndex++; loadValidationData(currentImageIndex); }
        });
    }

    if (btnTranscribedCorrectly) {
        btnTranscribedCorrectly.addEventListener('click', () => { /* ... (lógica sin cambios) ... */
            const currentData = ocrValidations[currentImageIndex];
            currentData.status = 'correct';
            currentData.correctedText = currentData.ocrText;
            console.log(`JS DEBUG: Imagen ${currentData.id}: Marcada como BIEN TRANSCRITA.`);
            goToNextImageOrFinish();
        });
    }

    if (btnTranscribedIncorrectly) {
        btnTranscribedIncorrectly.addEventListener('click', () => { /* ... (lógica sin cambios) ... */
            const currentData = ocrValidations[currentImageIndex];
            currentData.status = 'editing';
            setValidationInterfaceState('editing');
            console.log(`JS DEBUG: Imagen ${currentData.id}: Marcada como MAL TRANSCRITA, habilitando edición.`);
        });
    }

    if (btnConfirmCorrection) {
        btnConfirmCorrection.addEventListener('click', () => { /* ... (lógica sin cambios) ... */
            const currentData = ocrValidations[currentImageIndex];
            currentData.correctedText = correctedTextInput.value;
            currentData.status = 'corrected_saved';
            console.log(`JS DEBUG: Imagen ${currentData.id}: Corrección GUARDADA: "${currentData.correctedText}"`);
            goToNextImageOrFinish();
        });
    }

    if (btnCancelCorrection) {
        btnCancelCorrection.addEventListener('click', () => { /* ... (lógica sin cambios) ... */
            const currentData = ocrValidations[currentImageIndex];
            currentData.status = 'pending'; 
            currentData.correctedText = null; 
            setValidationInterfaceState('pending');
            console.log(`JS DEBUG: Imagen ${currentData.id}: Corrección CANCELADA.`);
        });
    }
    
    // BOTÓN "ANTERIOR" DE LA PÁGINA (AL PASO 2)
    if (btnOcrPreviousPage) {
        btnOcrPreviousPage.addEventListener('click', () => {
            console.log("JS DEBUG: Click en Anterior (para ir al paso 2)");
            if (enunciadoId) { // enunciadoId definido globalmente en este script
                let urlPaso2 = "{% url 'vista_mostrar_paso2_correccion' id_enunciado_ejercicio=0 %}".replace('0', enunciadoId.toString());
                // Corrección: .replace('/0/', `/${enunciadoId}/`) es más seguro si el ID no es siempre un solo dígito.
                // O mejor, si enunciadoId es el único argumento:
                urlPaso2 = "{% url 'vista_mostrar_paso2_correccion' 0 %}".replace('0', enunciadoId.toString());
                // Para la estructura de tu URL actual '/corregir-ejercicio/<int:id_enunciado_ejercicio>/paso2/'
                // la forma más segura de construirlo es:
                const baseUrlPaso2 = "{% url 'vista_mostrar_paso2_correccion' id_enunciado_ejercicio=99999 %}"; // Un ID placeholder
                urlPaso2 = baseUrlPaso2.replace('99999', enunciadoId.toString());

                console.log("JS DEBUG: Volviendo a Penalización Errores:", urlPaso2);
                window.location.href = urlPaso2;
            } else {
                console.error("JS ERROR: No se pudo obtener id_enunciado_ejercicio para volver al paso 2.");
                window.location.href = "{% url 'eleccion_menu' %}"; // Fallback
            }
        });
    }   

    // BOTÓN "SIGUIENTE" DE LA PÁGINA (AL PASO 4)
    if (btnOcrNextPage) {
        btnOcrNextPage.addEventListener('click', () => {
            if (!btnOcrNextPage.disabled) { 
                console.log("JS DEBUG: Click en Siguiente (para ir al paso 4)");
                if (enunciadoId) { // enunciadoId definido globalmente
                    console.log("JS DEBUG: Todas las validaciones completadas. Avanzando...");
                    
                    document.getElementById('step-2')?.classList.remove('active');
                    document.getElementById('step-2')?.classList.add('completed');
                    document.getElementById('step-3')?.classList.add('active');
                    if(progressLine) progressLine.style.width = '100%';
                    
                    const baseUrlPaso4 = "{% url 'vista_mostrar_paso4_final' id_enunciado_ejercicio=99999 %}"; // ID placeholder
                    const urlPaso4 = baseUrlPaso4.replace('99999', enunciadoId.toString());
                    
                    console.log("JS DEBUG: Avanzando a Corrección Final:", urlPaso4);
                    window.location.href = urlPaso4;
                } else {
                    console.error("JS ERROR: No se pudo obtener id_enunciado_ejercicio para ir al paso 4.");
                    alert("Error: No se pudo determinar el ejercicio para continuar.");
                }
            }
        });
    }

    // --- Inicialización ---
    updateProgressBarOCR();
    if (ocrValidations && ocrValidations.length > 0) { // Comprueba que ocrValidations exista y tenga items
        loadValidationData(currentImageIndex);
    } else {
        console.warn("JS WARN: No hay datos OCR para validar al inicializar.");
        if(validationsRemainingText) validationsRemainingText.textContent = "No hay imágenes para validar.";
        if(prevImageBtn) prevImageBtn.disabled = true;
        if(nextImageBtn) nextImageBtn.disabled = true;
        if(btnTranscribedCorrectly) btnTranscribedCorrectly.disabled = true;
        if(btnTranscribedIncorrectly) btnTranscribedIncorrectly.disabled = true;
        if(btnConfirmCorrection) btnConfirmCorrection.disabled = true;
        if(btnCancelCorrection) btnCancelCorrection.disabled = true;
        if(btnOcrNextPage) btnOcrNextPage.disabled = true; // Si no hay imágenes, no se puede pasar al siguiente.
        if(ocrValidationHint) ocrValidationHint.textContent = "No hay ejercicios para validar.";
        if(ocrValidationHint) ocrValidationHint.classList.add('visible');
    }
});
</script>
{% endblock extra_js %}