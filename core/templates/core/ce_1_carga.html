{% extends 'core/base_ce.html' %}
{% load static %}

{% block title %}EVIS - Cargar Datos del Ejercicio{% endblock title %}

{% block page_title_section %}
    {# Usamos el bloque de la base para el título principal de la página #}
    <div class="page-title-container">
        <h1>{% block page_main_title %}Sistema de Reconocimiento y Validación Automática{% endblock page_main_title %}</h1>
        {% block page_subtitle %}
            <p>
                Introduce los datos del ejercicio y los archivos necesarios para iniciar el proceso de corrección.
            </p>
        {% endblock page_subtitle %}
    </div>
{% endblock page_title_section %}

{% block extra_css %}
<style>
    /* Estilos específicos para ce_1_carga.html si son necesarios */
    /* Muchos de los estilos originales de tu ce_1_carga.html ya están en base_ce.html (como :root, body, etc.) */
    /* o son para elementos que vamos a quitar. Nos centraremos en los estilos del formulario. */

    .exercise-data-section { /* Ya lo tenías, lo mantenemos */
        width: 100%;
        max-width: 900px; /* Ajustado para un layout más centrado */
        margin-top: 20px; /* Espacio desde el título de página */
        margin-bottom: 40px;
        background-color: var(--white); /* Fondo blanco para esta sección dentro del área gris */
        padding: 30px 40px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .exercise-data-section h2 {
        text-align: center;
        font-size: clamp(20px, 3vw, 24px);
        font-weight: 800;
        margin-bottom: 30px;
        color: var(--text-primary);
    }

    .form-grid { /* Ya lo tenías, lo mantenemos */
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
    }

    .form-group { /* Ya lo tenías, lo mantenemos */
        display: flex;
        flex-direction: column;
    }

    .form-group label { /* Ya lo tenías, lo mantenemos */
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 15px;
        color: var(--text-secondary);
    }

    .form-group input[type="text"],
    .form-group input[type="date"],
    .form-group input[type="file"], /* Estilo para input file si se hiciera visible */
    .form-group select {
        padding: 12px 15px;
        border-radius: 8px;
        border: 1px solid var(--input-border);
        background-color: var(--input-background);
        font-family: 'Nunito Sans', sans-serif;
        font-size: 16px;
        width: 100%;
        transition: border-color 0.3s ease;
    }
    .form-group input:focus,
    .form-group select:focus,
    .form-group input[type="file"]:focus {
        outline: none;
        border-color: var(--primary-blue);
    }

    /* Estilos para el botón de "Seleccionar archivo" personalizado */
    .file-input-real { /* El input real oculto */
        display: none;
    }
    .file-input-styled-button { /* El botón que el usuario ve y clickea */
        display: inline-block;
        padding: 10px 15px;
        font-size: 0.95em;
        font-weight: 600;
        color: var(--primary-blue);
        background-color: var(--white);
        border: 1px dashed var(--primary-blue);
        border-radius: 6px;
        cursor: pointer;
        transition: background-color 0.2s ease, color 0.2s ease;
        text-align: center;
    }
    .file-input-styled-button:hover {
        background-color: var(--primary-blue);
        color: var(--white);
    }
    .file-input-styled-button i {
        margin-right: 8px;
    }
    .file-name-display { /* Para mostrar el nombre del archivo seleccionado */
        font-size: 0.85em;
        color: var(--text-secondary);
        margin-top: 8px;
        padding: 6px 8px;
        background-color: var(--field-background);
        border-radius: 4px;
        min-height: 20px; /* Para que tenga algo de altura incluso si no hay archivo */
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    .file-name-display.has-file {
        color: var(--text-primary);
        font-weight: 500;
    }


    .submit-button-container { /* Ya lo tenías */
        text-align: center;
        width: 100%;
        margin-top: 30px; /* Espacio antes del botón de enviar */
    }
    .submit-button { /* Ya lo tenías */
        background-color: var(--primary-blue); /* Usando el azul principal de EVIS */
        color: var(--white);
        border: none;
        border-radius: 8px; /* Bordes un poco menos redondeados que el upload-styled original */
        padding: 12px 35px;
        font-size: clamp(16px, 2.5vw, 18px);
        font-weight: 700; /* Un poco menos bold que 800 */
        cursor: pointer;
        transition: background-color 0.3s ease;
    }
    .submit-button:hover {
        background-color: #303dbb;
    }
    .submit-button:disabled { /* Ya lo tenías */
        background-color: #cccccc;
        cursor: not-allowed;
    }

    /* Popup de carga (si se usa) */
    .loading-popup { /* Ya lo tenías */ }
    .loading-popup.visible { /* Ya lo tenías */ }
    /* ... y el resto de estilos del popup ... */
</style>
{% endblock extra_css %}

{% block content %}
    <section class="exercise-data-section">
        <h2>Datos del Ejercicio</h2>
        <form id="exercise-form" method="POST" action="{% url 'procesar_carga_paso1' %}" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="form-grid">
                <div class="form-group">
                    <label for="nombre_ejercicio">Nombre Ejercicio</label>
                    <input type="text" id="nombre_ejercicio" name="nombre_ejercicio" list="nombre-ejercicio-list-ce1" placeholder="Ej: Creación de Tablas BD" required>
                    <datalist id="nombre-ejercicio-list-ce1">
                        {% for nombre_ej in lista_nombres_ejercicio %}
                            <option value="{{ nombre_ej }}">
                        {% empty %}
                            <option value="Práctica 1 - SQL DDL">
                        {% endfor %}
                    </datalist>
                </div>

                <div class="form-group">
                    <label for="asignatura">Asignatura</label>
                    <input type="text" id="asignatura" name="asignatura" list="asignatura-list-ce1" placeholder="Ej: Bases de Datos I" required>
                    <datalist id="asignatura-list-ce1">
                         {% for asig in lista_asignaturas %}
                            <option value="{{ asig }}">
                        {% empty %}
                            <option value="Bases de Datos I">
                        {% endfor %}
                    </datalist>
                </div>

                <div class="form-group">
                    <label for="enunciado_file_input">Enunciado del Ejercicio (.txt)</label>
                    <input type="file" id="enunciado_file_input" name="enunciado_file" accept=".txt" required class="file-input-real">
                    <button type="button" class="file-input-styled-button" onclick="document.getElementById('enunciado_file_input').click();">
                        <i class="fas fa-file-alt"></i> Seleccionar Enunciado
                    </button>
                    <div id="enunciado_file_display" class="file-name-display">Ningún archivo seleccionado</div>
                </div>

                 <div class="form-group">
                    <label for="estructura_tablas_file_input">Estructura de Tablas (Imagen)</label>
                    {# CAMBIO: accept ahora es para imágenes #}
                    <input type="file" id="estructura_tablas_file_input" name="estructura_tablas_file" accept="image/png, image/jpeg, image/jpg" class="file-input-real">
                     <button type="button" class="file-input-styled-button" onclick="document.getElementById('estructura_tablas_file_input').click();">
                        <i class="fas fa-image"></i> Seleccionar Imagen de Estructura
                    </button>
                     <div id="estructura_tablas_file_display" class="file-name-display">Ninguna imagen seleccionada</div>
                </div>

                <div class="form-group">
                    <label for="convocatoria_tipo">Convocatoria</label>
                    <input type="text" id="convocatoria_tipo" name="convocatoria_tipo" list="convocatoria-tipo-list-ce1" placeholder="Ej: Ordinaria" required>
                     <datalist id="convocatoria-tipo-list-ce1">
                        <option value="Ordinaria"></option>
                        <option value="Extraordinaria"></option>
                        <option value="Parcial 1"></option>
                        <option value="Parcial 2"></option>
                    </datalist>
                </div>

                <div class="form-group">
                    <label for="fecha_examen">Fecha del Examen</label>
                    <input type="date" id="fecha_examen" name="fecha_examen" required>
                </div>
            </div> {# Fin de .form-grid #}

            {# El input para los exámenes de los alumnos (la nube) lo mantenemos aquí #}
            {# Podría estilizarse de forma similar a los otros file inputs si se desea #}
            <div class="form-group" style="margin-top: 25px;">
                <label for="file-input-main-uploader">Exámenes de Alumnos (.zip o imágenes)</label>
                <input type="file" id="file-input-main-uploader" name="examenes_alumnos_principal" multiple accept=".zip, image/*" required class="file-input-real">
                <button type="button" class="file-input-styled-button" style="padding: 15px 20px; width:100%;" onclick="document.getElementById('file-input-main-uploader').click();">
                    <i class="fas fa-cloud-upload-alt"></i> Cargar Exámenes de Alumnos
                </button>
                <div id="selected-main-files-display" class="file-name-display">Ningún archivo/carpeta seleccionada</div>
            </div>


            {# Ya no se necesita .upload-status si los nombres se muestran en .file-name-display #}
            {# <div id="upload-status-message" class="upload-status"><i class="fas fa-check-circle"></i> ARCHIVOS CARGADOS</div> #}

            <div class="submit-button-container">
                <button type="submit" id="submit-paso1-btn" class="submit-button">Comenzar Proceso de Corrección</button>
            </div>
        </form>
    </section>

    {# Eliminadas las secciones .upload-section (la nube grande original) e .info-icons #}

    {# Popup de carga, si lo usas #}
    <div id="loading-popup" class="loading-popup" style="display: none;">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <p>Procesando ejercicio...</p>
        </div>
    </div>
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    function setupFileInputDisplay(inputId, displayId) {
        const fileInput = document.getElementById(inputId);
        const displayDiv = document.getElementById(displayId);
        if (fileInput && displayDiv) {
            fileInput.addEventListener('change', function() {
                if (this.files && this.files.length > 0) {
                    // Para input multiple, mostrar todos los nombres o un contador
                    if (this.multiple) {
                         if (this.files.length === 1 && this.files[0].type === "application/zip") {
                            displayDiv.textContent = `1 archivo ZIP: ${this.files[0].name}`;
                        } else {
                            displayDiv.textContent = `${this.files.length} archivo(s) seleccionado(s)`;
                        }
                    } else { // Input single
                        displayDiv.textContent = this.files[0].name;
                    }
                    displayDiv.classList.add('has-file');
                } else {
                    displayDiv.textContent = inputId.includes('estructura') ? 'Ninguna imagen seleccionada' : 'Ningún archivo seleccionado';
                    displayDiv.classList.remove('has-file');
                }
            });
        }
    }

    setupFileInputDisplay('enunciado_file_input', 'enunciado_file_display');
    setupFileInputDisplay('estructura_tablas_file_input', 'estructura_tablas_file_display');
    setupFileInputDisplay('file-input-main-uploader', 'selected-main-files-display');


    const exerciseForm = document.getElementById('exercise-form');
    const loadingPopup = document.getElementById('loading-popup');

    if (exerciseForm && loadingPopup) {
        exerciseForm.addEventListener('submit', function(event) {
            if (!exerciseForm.checkValidity()) {
                // Permite que la validación HTML5 por defecto muestre los errores
                // event.preventDefault(); // No es necesario si el botón es submit
                return;
            }
            loadingPopup.style.display = 'flex'; // Mostrar el popup
        });
    }
});
</script>
{% endblock extra_js %}